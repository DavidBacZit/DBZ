<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DBZ Staking Dashboard</title>
  <style>
    /* Global Styles */
    body {
      background: #f4f8fb;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    /* Main Container */
    .container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 480px;
      width: 100%;
      text-align: center;
    }
    /* Header */
    h1 {
      font-size: 24px;
      color: #333;
      margin: 0 0 20px;
    }
    /* Stats Card */
    .stats {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 15px;
      color: #333;
    }
    .stats p {
      margin: 6px 0;
    }
    /* Form Group */
    .group {
      margin-bottom: 20px;
    }
    input[type="number"] {
      padding: 10px;
      width: 70%;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      text-align: center;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 15px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      transition: background 0.25s, transform 0.2s;
    }
    button:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    .max-btn {
      margin-left: 8px;
      padding: 8px 12px;
      background: #28a745;
      font-size: 14px;
      border-radius: 6px;
    }
    .max-btn:hover {
      background: #1e7e34;
    }
    /* Wallet Connect area */
    #wallet-connection { margin-bottom: 15px; }
    .hidden { display: none; }
    /* Status Message */
    .status {
      font-size: 14px;
      color: #555;
      min-height: 20px;
      margin-top: 10px;
    }
  </style>
  <!-- CDN Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.8/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>DBZ Staking Dashboard</h1>
    
    <!-- Stats Card -->
    <div class="stats">
      <p id="staked-info">Your Staked: - DBZ</p>
      <p id="wallet-balance-info">Your Wallet Balance: - DBZ</p>
      <p id="apr-info">APR: - %</p>
    </div>
    
    <!-- Wallet Connection Area -->
    <div id="wallet-connection">
      <button id="connect-wallet-btn">Connect Wallet</button>
    </div>
    <p class="status" id="status">Disconnected</p>
    
    <!-- Stake Section -->
    <div class="group">
      <h3>Stake Tokens</h3>
      <input type="number" id="stake-amount" placeholder="Amount to stake" />
      <button class="max-btn" id="stake-max-btn">Max</button>
      <br />
      <button id="stake-btn">Stake</button>
    </div>
    
    <!-- Unstake Section -->
    <div class="group">
      <h3>Unstake Tokens</h3>
      <input type="number" id="unstake-amount" placeholder="Amount to unstake" />
      <button class="max-btn" id="unstake-max-btn">Max</button>
      <br />
      <button id="unstake-btn">Unstake</button>
    </div>
    
    <!-- Claim Reward Section -->
    <div class="group">
      <h3>Claim Reward</h3>
      <button id="claim-btn">Claim Reward</button>
    </div>
  </div>

  <script>
    // Network & Contract Settings
    const CONTRACT_ADDRESS = "0x8000075D0b47DdbCBE5D550Ef206377ea744A897";
    const RPC_URL = "https://rpc-testnet.monad.xyz";
    const CHAIN_ID = 10143; // Monad Testnet

    // DBZ Token Address
    const TOKEN_ADDRESS = "0x070deA104E73d3513b7D04389101A90413ae1Da8";

    // Minimal ABI for the staking contract
    const StakeTokenABI = [
      {
        "inputs": [{"internalType": "uint256","name": "amount","type": "uint256"}],
        "name": "stakeTokens",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256","name": "amount","type": "uint256"}],
        "name": "unstakeTokens",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "claimTokenReward",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "address","name": "","type": "address"}],
        "name": "tokenStakers",
        "outputs": [
          {"internalType": "uint256","name": "amount","type": "uint256"},
          {"internalType": "uint256","name": "rewardDebt","type": "uint256"},
          {"internalType": "uint256","name": "pending","type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "totalTokenStaked",
        "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    // Minimal ERC20 ABI for the token
    const ERC20ABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];

    let provider, signer, contract, tokenContract;
    let web3Modal;
    const providerOptions = {
      walletconnect: {
        package: window.WalletConnectProvider.default,
        options: { rpc: { [CHAIN_ID]: RPC_URL }, chainId: CHAIN_ID }
      }
    };

    web3Modal = new window.Web3Modal.default({
      network: "custom",
      cacheProvider: true,
      providerOptions,
    });

    const statusEl = document.getElementById("status");
    const walletSection = document.getElementById("wallet-connection");

    // Utility: round to two decimals
    const round2 = (value) => parseFloat(value).toFixed(2);

    // Gas settings to use manually if not fetched
    const manualGasPrice = ethers.utils.parseUnits("52", "gwei");  
    const approveGasLimit = 50000;  
    const stakeGasLimit = 160000;

    // Switch network if needed
    async function switchToMonadTestnet() {
      try {
        await provider.provider.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: "0x" + CHAIN_ID.toString(16) }]
        });
      } catch (err) {
        console.error("Network switch error:", err);
        statusEl.textContent = "Please switch to Monad Testnet.";
      }
    }

    async function connectWallet() {
      try {
        const instance = await web3Modal.connect();
        provider = new ethers.providers.Web3Provider(instance);
        const network = await provider.getNetwork();
        if (network.chainId !== CHAIN_ID) await switchToMonadTestnet();
        signer = provider.getSigner();
        // Show disconnect button after connection
        showDisconnectButton();
        // Hide connect wallet button
        walletSection.classList.add("hidden");
        statusEl.textContent = "";
        contract = new ethers.Contract(CONTRACT_ADDRESS, StakeTokenABI, signer);
        tokenContract = new ethers.Contract(TOKEN_ADDRESS, ERC20ABI, signer);
        refreshGeneralStats();
        setInterval(refreshGeneralStats, 60000);
      } catch (err) {
        console.error("Error connecting wallet:", err);
        statusEl.textContent = "Error connecting wallet";
      }
    }

    function disconnectWallet() {
      web3Modal.clearCachedProvider();
      location.reload();
    }

    function showDisconnectButton() {
      const btn = document.createElement("button");
      btn.textContent = "Disconnect Wallet";
      btn.style.marginTop = "10px";
      btn.style.padding = "8px 16px";
      btn.style.fontSize = "14px";
      btn.style.border = "none";
      btn.style.borderRadius = "6px";
      btn.style.background = "#dc3545";
      btn.style.color = "#fff";
      btn.style.cursor = "pointer";
      btn.addEventListener("click", disconnectWallet);
      walletSection.appendChild(btn);
    }

    // Check allowance and auto-approve if needed, then stake
    async function approveAndStake() {
      const amountInput = document.getElementById("stake-amount").value;
      if (!contract || !amountInput || parseFloat(amountInput) <= 0) {
        statusEl.textContent = "Enter a valid stake amount.";
        return;
      }
      const stakeAmount = ethers.utils.parseUnits(amountInput, 18);
      const userAddress = await signer.getAddress();
      try {
        const allowance = await tokenContract.allowance(userAddress, CONTRACT_ADDRESS);
        if (allowance.lt(stakeAmount)) {
          const walletBal = await tokenContract.balanceOf(userAddress);
          statusEl.textContent = "Approving tokens...";
          const txApprove = await tokenContract.approve(
            CONTRACT_ADDRESS,
            walletBal,
            { gasLimit: approveGasLimit, gasPrice: manualGasPrice }
          );
          await txApprove.wait();
        }
        stakeTokens();
      } catch (err) {
        console.error("Deposit error:", err);
        statusEl.textContent = "Deposit error. Please try again.";
      }
    }

    async function stakeTokens() {
      const amountInput = document.getElementById("stake-amount").value;
      if (!contract || !amountInput) return;
      try {
        statusEl.textContent = "Staking...";
        const tx = await contract.stakeTokens(
          ethers.utils.parseUnits(amountInput, 18),
          { gasLimit: stakeGasLimit, gasPrice: manualGasPrice }
        );
        await tx.wait();
        statusEl.textContent = "Stake successful!";
        setTimeout(refreshGeneralStats, 5000);
      } catch (err) {
        console.error("Error staking:", err);
        statusEl.textContent = "Error staking";
      }
    }

    async function unstakeTokens() {
      const unstakeInput = document.getElementById("unstake-amount").value;
      if (!contract || !unstakeInput || parseFloat(unstakeInput) <= 0) {
        statusEl.textContent = "Enter a valid unstake amount.";
        return;
      }
      try {
        statusEl.textContent = "Unstaking...";
        const tx = await contract.unstakeTokens(
          ethers.utils.parseUnits(unstakeInput, 18)
        );
        await tx.wait();
        statusEl.textContent = "Unstake successful!";
        setTimeout(refreshGeneralStats, 5000);
      } catch (err) {
        console.error("Error unstaking:", err);
        statusEl.textContent = "Error unstaking";
      }
    }

    async function claimReward() {
      if (!contract) return;
      try {
        statusEl.textContent = "Claiming reward...";
        const tx = await contract.claimTokenReward();
        await tx.wait();
        statusEl.textContent = "Reward claimed!";
        setTimeout(refreshGeneralStats, 5000);
      } catch (err) {
        console.error("Error claiming reward:", err);
        statusEl.textContent = "Error claiming reward";
      }
    }

    async function getWalletBalance() {
      const addr = await signer.getAddress();
      const bal = await tokenContract.balanceOf(addr);
      return round2(ethers.utils.formatUnits(bal, 18));
    }

    async function getStakedInfo() {
      const addr = await signer.getAddress();
      const staker = await contract.tokenStakers(addr);
      return { staked: round2(ethers.utils.formatUnits(staker.amount, 18)) };
    }

    async function getAPR() {
      try {
        const totalStakedBN = await contract.totalTokenStaked();
        if (totalStakedBN.isZero()) return "0.00";
        const totalStaked = parseFloat(ethers.utils.formatUnits(totalStakedBN, 18));
        return round2(3784320000000 / totalStaked);
      } catch (err) {
        console.error("Error calculating APR:", err);
        return "-";
      }
    }

    async function refreshGeneralStats() {
      if (!signer || !contract || !tokenContract) return;
      try {
        const stakedData = await getStakedInfo();
        const walletBal = await getWalletBalance();
        const apr = await getAPR();
        document.getElementById("staked-info").textContent = "Your Staked: " + stakedData.staked + " DBZ";
        document.getElementById("wallet-balance-info").textContent = "Your Wallet Balance: " + walletBal + " DBZ";
        document.getElementById("apr-info").textContent = "APR: " + apr + " %";
      } catch (err) {
        console.error("Error refreshing stats:", err);
      }
    }

    async function setMaxStake() {
      try {
        const walletBal = await getWalletBalance();
        document.getElementById("stake-amount").value = walletBal;
      } catch (err) {
        console.error("Error setting max stake:", err);
      }
    }

    async function setMaxUnstake() {
      try {
        const stakedData = await getStakedInfo();
        document.getElementById("unstake-amount").value = stakedData.staked;
      } catch (err) {
        console.error("Error setting max unstake:", err);
      }
    }

    // Event Listeners
    document.getElementById("connect-wallet-btn").addEventListener("click", connectWallet);
    document.getElementById("stake-btn").addEventListener("click", approveAndStake);
    document.getElementById("unstake-btn").addEventListener("click", unstakeTokens);
    document.getElementById("claim-btn").addEventListener("click", claimReward);
    document.getElementById("stake-max-btn").addEventListener("click", setMaxStake);
    document.getElementById("unstake-max-btn").addEventListener("click", setMaxUnstake);

    if (web3Modal.cachedProvider) {
      connectWallet();
    }
  </script>
</body>
</html>
